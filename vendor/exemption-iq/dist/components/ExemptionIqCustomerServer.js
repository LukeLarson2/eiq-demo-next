import{getSessionToken as P}from"../server/helpers/getSessionToken";import{getAvalaraCredentials as U}from"../server/helpers/getAvalaraCredentials";import _ from"./ExemptionIqCertificateTable";import p from"react";import{readEnv as v}from"../server/helpers/readEnv";async function V({customerCode:o,customerInfo:a,state:C,showDownload:E=!1,manualValidation:S=!0,enableGenCertModal:$=!1,buttonText:x="Add New Certificate",buttonTextColor:m,primaryColor:b="#2966B1",dangerColor:g="#E76F51",successColor:k="#14AE5C",buttonStyles:D,onComplete:T,avataxBaseUrl:j,environment:N="production"}){try{const t=v("EIQ_USERNAME"),l=v("EIQ_PASSWORD");if(!t||!l)throw new Error("Ensure EIQ_USERNAME and EIQ_PASSWORD have been set in .env");const c=await P({username:t,password:l}),i=await U(c),r=Buffer.from(`${i.username}:${i.password}`).toString("base64"),n=typeof process!="undefined"?process.env.AVATAX_API_BASE:"https://rest.avatax.com/api/v2",h=await fetch(`${n}/companies/${i.companyId}/customers/${o}`,{headers:{"X-Avalara-Client":i.clientId,Authorization:`Basic ${r}`}});let s=h.ok?await h.json():null;if(!s){const e=await fetch(`${n}/companies/${i.companyId}/customers`,{method:"POST",headers:{"X-Avalara-Client":i.clientId,Authorization:`Basic ${r}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:i.companyId,customerCode:o,name:(a==null?void 0:a.name)||"",emailAddress:(a==null?void 0:a.emailAddress)||"",line1:(a==null?void 0:a.addressLine1)||"",line2:(a==null?void 0:a.addressLine2)||"",city:(a==null?void 0:a.city)||"",postalCode:(a==null?void 0:a.postalCode)||"",phoneNumber:(a==null?void 0:a.phoneNumber)||"",faxNumber:(a==null?void 0:a.faxNumber)||"",country:(a==null?void 0:a.country)||"US",region:(a==null?void 0:a.region)||""})});if(!e.ok)throw new Error("Failed to create customer");s=await e.json()}const w=await fetch(`${n}/companies/${i.companyId}/ecommercetokens`,{method:"POST",headers:{"X-Avalara-Client":i.clientId,Authorization:`Basic ${r}`,"Content-Type":"application/json"},body:JSON.stringify({customerNumber:s.customerCode})});if(!w.ok)throw new Error("Failed to generate token");const B=await w.json(),d=await(await fetch(`${n}/companies/${i.companyId}/customers/${o}?$include=active_certificates`,{headers:{"X-Avalara-Client":i.clientId,Authorization:`Basic ${r}`}})).json(),R=((d==null?void 0:d.activeCertificates)||[]).map(e=>{var y,A;return{id:String(e.id),signedDate:new Date(e.certificate.signedDate).toLocaleDateString(),expirationDate:e.certificate.expirationDate?new Date(e.certificate.expirationDate).toLocaleDateString():"N/A",exposureZone:((y=e.exposureZone)==null?void 0:y.name)||"Unknown",exemptionReason:(A=e==null?void 0:e.actualTaxCode)==null?void 0:A.name,status:e.certificate.valid?"valid":"invalid",pdfUrl:`${n}/companies/${i.companyId}/certificates/${e.id}/attachment`}});return p.createElement(_,{token:B.token,sessionToken:c,certificates:R,customer:s,customerInfo:a,state:C,showDownload:E,manualValidation:S,enableGenCertModal:$,buttonText:x,buttonTextColor:m,primaryColor:b,dangerColor:g,successColor:k,buttonStyles:D,onComplete:T,environment:N})}catch(t){return console.error("ExemptionIqCustomerServer error:",t),p.createElement("div",{style:{marginTop:"1rem",color:"#ef4444"}},p.createElement("p",null,t))}}export{V as ExemptionIqCustomerServer};
