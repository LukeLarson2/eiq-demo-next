import{getSessionToken as D}from"../server/helpers/getSessionToken";import{getAvalaraCredentials as T}from"../server/helpers/getAvalaraCredentials";import I from"./ExemptionIqCertificateTable";import c from"react";import{readEnv as u}from"../server/helpers/readEnv";async function z({customerCode:s,customerInfo:t,state:f,showDownload:h=!1,manualValidation:w=!0,enableGenCertModal:y=!1,buttonText:A="Add New Certificate",buttonTextColor:v,primaryColor:C="#2966B1",dangerColor:E="#E76F51",successColor:S="#14AE5C",buttonStyles:$,onComplete:x,avataxBaseUrl:N,environment:b="production"}){try{const o=u("EIQ_USERNAME"),d=u("EIQ_PASSWORD");if(!o||!d)throw new Error("Ensure EIQ_USERNAME and EIQ_PASSWORD have been set in .env");const m=await D({username:o,password:d}),e=await T(m),i=Buffer.from(`${e.username}:${e.password}`).toString("base64"),n=typeof process<"u"?process.env.AVATAX_API_BASE:"https://rest.avatax.com/api/v2",p=await fetch(`${n}/companies/${e.companyId}/customers/${s}`,{headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${i}`}});let r=p.ok?await p.json():null;if(!r){const a=await fetch(`${n}/companies/${e.companyId}/customers`,{method:"POST",headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${i}`,"Content-Type":"application/json"},body:JSON.stringify({companyId:e.companyId,customerCode:s,name:t?.name||"",emailAddress:t?.emailAddress||"",line1:t?.addressLine1||"",line2:t?.addressLine2||"",city:t?.city||"",postalCode:t?.postalCode||"",phoneNumber:t?.phoneNumber||"",faxNumber:t?.faxNumber||"",country:t?.country||"US",region:t?.region||""})});if(!a.ok)throw new Error("Failed to create customer");r=await a.json()}const l=await fetch(`${n}/companies/${e.companyId}/ecommercetokens`,{method:"POST",headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${i}`,"Content-Type":"application/json"},body:JSON.stringify({customerNumber:r.customerCode})});if(!l.ok)throw new Error("Failed to generate token");const g=await l.json(),k=((await(await fetch(`${n}/companies/${e.companyId}/customers/${s}?$include=active_certificates`,{headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${i}`}})).json())?.activeCertificates||[]).map(a=>({id:String(a.certificate.id),signedDate:new Date(a.certificate.signedDate).toLocaleDateString(),expirationDate:a.certificate.expirationDate?new Date(a.certificate.expirationDate).toLocaleDateString():"N/A",exposureZone:a.exposureZone?.name||"Unknown",exemptionReason:a?.actualTaxCode?.name,status:a.certificate.valid?"valid":"invalid",pdfUrl:`${n}/companies/${e.companyId}/certificates/${a.id}/attachment`}));return c.createElement(I,{token:g.token,sessionToken:m,certificates:k,customer:r,customerInfo:t,state:f,showDownload:h,manualValidation:w,enableGenCertModal:y,buttonText:A,buttonTextColor:v,primaryColor:C,dangerColor:E,successColor:S,buttonStyles:$,onComplete:x,environment:b})}catch(o){return console.error("ExemptionIqCustomerServer error:",o),c.createElement("div",{style:{marginTop:"1rem",color:"#ef4444"}},c.createElement("p",null,o))}}export{z as ExemptionIqCustomerServer};
