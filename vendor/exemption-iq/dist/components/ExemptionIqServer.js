import{getAvalaraCredentials as u}from"../server/helpers/getAvalaraCredentials";import{getSessionToken as y}from"../server/helpers/getSessionToken";import w from"./ExemptionIqButton";import m from"react";import{readEnv as p}from"../server/helpers/readEnv";const c=typeof process!="undefined"?process.env.AVATAX_API_BASE:"https://rest.avatax.com/api/v2",g={container:{position:"relative"},error:{marginTop:"1rem",color:"#ef4444",fontSize:"0.875rem"}};async function h(n,e){const a=Buffer.from(`${e.username}:${e.password}`).toString("base64"),i=await fetch(`${c}/companies/${e.companyId}/customers/${n}`,{headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${a}`}});if(!i.ok){if(i.status===404)return null;throw new Error(`Failed to get customer: ${await i.text()}`)}return await i.json()}async function C(n,e,a,i){const t=Buffer.from(`${a.username}:${a.password}`).toString("base64"),r={companyId:a.companyId,customerCode:n,name:e==null?void 0:e.name,emailAddress:e==null?void 0:e.emailAddress,line1:(e==null?void 0:e.addressLine1)||"",line2:(e==null?void 0:e.addressLine2)||"",city:(e==null?void 0:e.city)||"",postalCode:(e==null?void 0:e.postalCode)||"",phoneNumber:(e==null?void 0:e.phoneNumber)||"",faxNumber:(e==null?void 0:e.faxNumber)||"",country:(e==null?void 0:e.country)||"US",region:(e==null?void 0:e.region)||i||""},o=await fetch(`${c}/companies/${a.companyId}/customers`,{method:"POST",headers:{"X-Avalara-Client":a.clientId,Authorization:`Basic ${t}`,"Content-Type":"application/json"},body:JSON.stringify(r)});if(!o.ok)throw new Error(`Failed to create customer: ${await o.text()}`);return await o.json()}async function A(n,e,a){const i=Buffer.from(`${a.username}:${a.password}`).toString("base64"),t={customerNumber:n,...e},r=await fetch(`${c}/companies/${a.companyId}/ecommercetokens`,{method:"POST",headers:{"X-Avalara-Client":a.clientId,Authorization:`Basic ${i}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!r.ok)throw new Error(`Failed to generate token: ${await r.text()}`);return(await r.json()).token}async function $(n,e,a){const i=Buffer.from(`${a.username}:${a.password}`).toString("base64"),t=await fetch(`${c}/companies/${a.companyId}/customers/${n}?$include=active_certificates`,{headers:{"X-Avalara-Client":a.clientId,Authorization:`Basic ${i}`}});if(!t.ok)return null;const r=await t.json();return((r==null?void 0:r.activeCertificates)||[]).find(d=>{var l,s;return((l=d.exposureZone)==null?void 0:l.name.toLowerCase())===e.toLowerCase()&&((s=d.certificate)==null?void 0:s.valid)})||null}async function z(n){let e=null,a=!1,i=null,t=null,r=null;const o=p("EIQ_USERNAME"),d=p("EIQ_PASSWORD");if(!o||!d)throw new Error("Ensure EIQ_USERNAME and EIQ_PASSWORD have been set in .env");const l=await y({username:o,password:d});try{const s=await u(l);t=await h(n.customerCode,s),t||(t=await C(n.customerCode,n.customerInfo,s,n==null?void 0:n.state)),e=await A(t.customerCode,{name:t.name,emailAddress:t.emailAddress,addressLine1:t.line1,addressLine2:t.line2,city:t.city,postalCode:t.postalCode,phoneNumber:t.phoneNumber,faxNumber:t.faxNumber,country:t.country,region:t.region},s),r=await $(t.customerCode,n.state,s),a=!0}catch(s){console.error("ExemptionIqServer error:",s),i=s.message,a=!1}return m.createElement("div",{style:g.container},m.createElement(w,{token:e,sessionToken:l,isAuthorized:a,...n,customerCode:n.customerCode,customerInfo:n.customerInfo,matchingCertificate:r}),i&&m.createElement("div",{style:g.error},m.createElement("p",null,i)))}export{z as ExemptionIqServer};
