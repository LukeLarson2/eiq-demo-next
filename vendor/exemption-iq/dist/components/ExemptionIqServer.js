import{getAvalaraCredentials as f}from"../server/helpers/getAvalaraCredentials";import{getSessionToken as g}from"../server/helpers/getSessionToken";import y from"./ExemptionIqButton";import c from"react";import{readEnv as l}from"../server/helpers/readEnv";const u=typeof process<"u"?process.env.AVATAX_API_BASE:"https://rest.avatax.com/api/v2",p={container:{position:"relative"},error:{marginTop:"1rem",color:"#ef4444",fontSize:"0.875rem"}};async function w(o,e){const n=Buffer.from(`${e.username}:${e.password}`).toString("base64"),r=await fetch(`${u}/companies/${e.companyId}/customers/${o}`,{headers:{"X-Avalara-Client":e.clientId,Authorization:`Basic ${n}`}});if(!r.ok){if(r.status===404)return null;throw new Error(`Failed to get customer: ${await r.text()}`)}return await r.json()}async function h(o,e,n,r){const t=Buffer.from(`${n.username}:${n.password}`).toString("base64"),s={companyId:n.companyId,customerCode:o,name:e?.name,emailAddress:e?.emailAddress,line1:e?.addressLine1||"",line2:e?.addressLine2||"",city:e?.city||"",postalCode:e?.postalCode||"",phoneNumber:e?.phoneNumber||"",faxNumber:e?.faxNumber||"",country:e?.country||"US",region:e?.region||r||""},a=await fetch(`${u}/companies/${n.companyId}/customers`,{method:"POST",headers:{"X-Avalara-Client":n.clientId,Authorization:`Basic ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(!a.ok)throw new Error(`Failed to create customer: ${await a.text()}`);return await a.json()}async function C(o,e,n){const r=Buffer.from(`${n.username}:${n.password}`).toString("base64"),t={customerNumber:o,...e},s=await fetch(`${u}/companies/${n.companyId}/ecommercetokens`,{method:"POST",headers:{"X-Avalara-Client":n.clientId,Authorization:`Basic ${r}`,"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok)throw new Error(`Failed to generate token: ${await s.text()}`);return(await s.json()).token}async function A(o,e,n){const r=Buffer.from(`${n.username}:${n.password}`).toString("base64"),t=await fetch(`${u}/companies/${n.companyId}/customers/${o}?$include=active_certificates`,{headers:{"X-Avalara-Client":n.clientId,Authorization:`Basic ${r}`}});return t.ok&&((await t.json())?.activeCertificates||[]).find(m=>m.exposureZone?.name.toLowerCase()===e.toLowerCase()&&m.certificate?.valid)||null}async function T(o){let e=null,n=!1,r=null,t=null,s=null;const a=l("EIQ_USERNAME"),m=l("EIQ_PASSWORD");if(!a||!m)throw new Error("Ensure EIQ_USERNAME and EIQ_PASSWORD have been set in .env");const d=await g({username:a,password:m});try{const i=await f(d);t=await w(o.customerCode,i),t||(t=await h(o.customerCode,o.customerInfo,i,o?.state)),e=await C(t.customerCode,{name:t.name,emailAddress:t.emailAddress,addressLine1:t.line1,addressLine2:t.line2,city:t.city,postalCode:t.postalCode,phoneNumber:t.phoneNumber,faxNumber:t.faxNumber,country:t.country,region:t.region},i),s=await A(t.customerCode,o.state,i),n=!0}catch(i){console.error("ExemptionIqServer error:",i),r=i.message,n=!1}return c.createElement("div",{style:p.container},c.createElement(y,{token:e,sessionToken:d,isAuthorized:n,...o,customerCode:o.customerCode,customerInfo:o.customerInfo,matchingCertificate:s}),r&&c.createElement("div",{style:p.error},c.createElement("p",null,r)))}export{T as ExemptionIqServer};
