"use client";import{useEffect as $,useState as o}from"react";import G from"./AvataxCertificateClient";import e from"react";import P from"./ui/Modal";import Y from"./ui/PDFModal";import{getApiUrl as p}from"../server/helpers/getApiUrl";const r={button:{padding:"0.75rem 1.5rem",borderRadius:"6px",fontWeight:500,transition:"all 150ms ease-in-out",display:"inline-flex",alignItems:"center",justifyContent:"center",border:"none"},spinner:{animation:"eiq-spin 1s linear infinite",marginRight:"0.75rem",height:"1.25rem",width:"1.25rem"},certModal:{display:"flex",flexDirection:"column",gap:"1rem"},certInfoBox:{backgroundColor:"#f9fafb",padding:"1rem",borderRadius:"0.5rem",border:"1px solid #d1d5db"},actions:{display:"flex",justifyContent:"flex-end",gap:"1rem",paddingTop:"1rem"},viewPdfBtn:{color:"#2563eb",textDecoration:"underline",background:"none",border:"none",padding:0,font:"inherit",cursor:"pointer"},useCertBtn:{backgroundColor:"#e5e7eb",fontSize:"0.875rem",padding:"0.5rem 1rem",borderRadius:"4px",border:"none",cursor:"pointer"},uploadCertBtn:{color:"white",fontSize:"0.875rem",padding:"0.5rem 1rem",borderRadius:"4px",border:"none",cursor:"pointer"},error:{marginTop:"1rem",color:"#E76F51"},success:{width:"100%"},successBtn:{backgroundColor:"#14AE5C",color:"white",padding:"0.5rem 1rem",borderRadius:"4px",opacity:.75,cursor:"not-allowed",border:"none"},keyframes:`
    @keyframes eiq-spin {
      to {
        transform: rotate(360deg);
      }
    }
  `};function oe({customerCode:n,customerInfo:w,state:u,showDownload:I=!1,manualValidation:M=!0,buttonText:q="Tax Exempt",buttonTextColor:O,primaryColor:x="#2966B1",dangerColor:b="#E76F51",successColor:j="#14AE5C",buttonStyles:k,onComplete:v,framework:l="next",environment:A="production"}){const[S,F]=o(null),[m,E]=o(null),[i,g]=o(!1),[B,d]=o(!1),[z,L]=o(null),[h,C]=o(!1),[s,N]=o(null),[U,c]=o(!1),[y,D]=o(null);$(()=>{if(typeof window<"u"&&!document.getElementById("eiq-keyframes")){const t=document.createElement("style");t.id="eiq-keyframes",t.innerHTML=r.keyframes,document.head.appendChild(t)}(async()=>{try{const t=await fetch(p(l,"session"),{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch session");const f=await t.json();document.cookie=`eiq_session_token=${f.token}; path=/; max-age=3600; SameSite=Lax`}catch(t){console.error("\u274C Failed to set session cookie",t)}})()},[]);const J=()=>!n||m?b:h?j:x,V=()=>n?i?"Processing...":h?"Exempt \u2713":q:"No Customer Code",W=async()=>{if(!(!n||i)){g(!0),E(null);try{const t=await(await fetch(p(l,"validate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerCode:n,state:u})})).json();if(t.status==="valid"&&t.certificates.length>0){N(t.certificates[0]),c(!0);return}const f=await fetch(p(l,"gencert/token"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerCode:n,...w})});if(!f.ok)throw new Error("Failed to generate certificate token");const{token:_}=await f.json();F(_),d(!0)}catch(a){console.error("Certificate generation error:",a),E(a.message||"Failed to generate certificate"),F(null)}finally{g(!1)}}},H=async a=>{L(a),C(!0),g(!1),d(!1)},T=()=>{d(!1),z&&C(!0)};return e.createElement("div",null,!B&&!h&&e.createElement("button",{onClick:W,disabled:!n||i,style:{...r.button,backgroundColor:J(),color:O||"#FFFFFF",cursor:!n||i?"not-allowed":"pointer",opacity:!n||i?.7:1,...k?JSON.parse(k):{}}},e.createElement("span",{style:{display:"inline-flex",alignItems:"center"}},i&&e.createElement("svg",{style:r.spinner,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},e.createElement("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.createElement("path",{fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})),V())),U&&s&&e.createElement(P,{isOpen:!0,onClose:()=>c(!1)},e.createElement("div",{style:r.certModal},e.createElement("h2",{style:{fontSize:"1.125rem",fontWeight:600}},"A valid certificate already exists for ",u),e.createElement("p",{style:{fontSize:"0.875rem",color:"#4B5563"}},"You can use this certificate or upload a new one."),e.createElement("div",{style:r.certInfoBox},e.createElement("p",null,e.createElement("strong",null,"Reason:")," ",s.actualTaxCode.name),e.createElement("p",null,e.createElement("strong",null,"Signed:")," ",new Date(s.certificate.signedDate).toLocaleDateString()),e.createElement("p",null,e.createElement("strong",null,"Expires:")," ",s.certificate.expirationDate?new Date(s.certificate.expirationDate).toLocaleDateString():"N/A"),e.createElement("button",{onClick:()=>D(p(l,`certificate/${s.certificate.id}`)),style:r.viewPdfBtn},"View PDF")),e.createElement("div",{style:r.actions},e.createElement("button",{style:r.useCertBtn,onClick:()=>{c(!1),C(!0),v?.(!0)}},"Use This Certificate"),e.createElement("button",{style:{...r.uploadCertBtn,backgroundColor:x},onClick:()=>{c(!1),d(!0)}},"Upload New Certificate")))),y&&e.createElement(Y,{isOpen:!!y,onClose:()=>D(null),pdfUrl:y,title:"Certificate PDF Preview"}),B&&S&&e.createElement(P,{isOpen:!0,onClose:T},e.createElement(G,{token:S,state:u,showDownload:I,manualValidation:M,onCertificateComplete:H,onClose:T,customerInfo:w,customerCode:n,mode:"renew",onComplete:v,environment:A})),m&&e.createElement("div",{style:{marginTop:"1rem",color:"#ef4444"}},e.createElement("p",null,m)))}export{oe as ExemptionIqClient};
