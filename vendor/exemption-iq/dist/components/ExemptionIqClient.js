"use client";import{useEffect as $,useState as i}from"react";import G from"./AvataxCertificateClient";import e from"react";import P from"./ui/Modal";import Y from"./ui/PDFModal";import{getApiUrl as d}from"../server/helpers/getApiUrl";const n={button:{padding:"0.75rem 1.5rem",borderRadius:"6px",fontWeight:500,transition:"all 150ms ease-in-out",display:"inline-flex",alignItems:"center",justifyContent:"center",border:"none"},spinner:{animation:"eiq-spin 1s linear infinite",marginRight:"0.75rem",height:"1.25rem",width:"1.25rem"},certModal:{display:"flex",flexDirection:"column",gap:"1rem"},certInfoBox:{backgroundColor:"#f9fafb",padding:"1rem",borderRadius:"0.5rem",border:"1px solid #d1d5db"},actions:{display:"flex",justifyContent:"flex-end",gap:"1rem",paddingTop:"1rem"},viewPdfBtn:{color:"#2563eb",textDecoration:"underline",background:"none",border:"none",padding:0,font:"inherit",cursor:"pointer"},useCertBtn:{backgroundColor:"#e5e7eb",fontSize:"0.875rem",padding:"0.5rem 1rem",borderRadius:"4px",border:"none",cursor:"pointer"},uploadCertBtn:{color:"white",fontSize:"0.875rem",padding:"0.5rem 1rem",borderRadius:"4px",border:"none",cursor:"pointer"},error:{marginTop:"1rem",color:"#E76F51"},success:{width:"100%"},successBtn:{backgroundColor:"#14AE5C",color:"white",padding:"0.5rem 1rem",borderRadius:"4px",opacity:.75,cursor:"not-allowed",border:"none"},keyframes:`
    @keyframes eiq-spin {
      to {
        transform: rotate(360deg);
      }
    }
  `};function oe({customerCode:o,customerInfo:h,state:y,showDownload:M=!1,manualValidation:O=!0,buttonText:I="Tax Exempt",buttonTextColor:j,primaryColor:v="#2966B1",dangerColor:S="#E76F51",successColor:q="#14AE5C",buttonStyles:c,onComplete:f,framework:l="next",environment:N="production"}){const[E,C]=i(null),[w,F]=i(null),[s,b]=i(!1),[B,p]=i(!1),[A,z]=i(null),[u,x]=i(!1),[a,L]=i(null),[U,g]=i(!1),[k,D]=i(null);$(()=>{if(typeof window!="undefined"&&!document.getElementById("eiq-keyframes")){const t=document.createElement("style");t.id="eiq-keyframes",t.innerHTML=n.keyframes,document.head.appendChild(t)}(async()=>{try{const t=await fetch(d(l,"session"),{credentials:"include"});if(!t.ok)throw new Error("Failed to fetch session");const m=await t.json();document.cookie=`eiq_session_token=${m.token}; path=/; max-age=3600; SameSite=Lax`}catch(t){console.error("\u274C Failed to set session cookie",t)}})()},[]);const J=()=>!o||w?S:u?q:v,V=()=>o?s?"Processing...":u?"Exempt \u2713":I:"No Customer Code",W=async()=>{if(!(!o||s)){b(!0),F(null);try{const t=await(await fetch(d(l,"validate"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerCode:o,state:y})})).json();if(t.status==="valid"&&t.certificates.length>0){L(t.certificates[0]),g(!0);return}const m=await fetch(d(l,"gencert/token"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerCode:o,...h})});if(!m.ok)throw new Error("Failed to generate certificate token");const{token:_}=await m.json();C(_),p(!0)}catch(r){console.error("Certificate generation error:",r),F(r.message||"Failed to generate certificate"),C(null)}finally{b(!1)}}},H=async r=>{z(r),x(!0),b(!1),p(!1)},T=()=>{p(!1),A&&x(!0)};return e.createElement("div",null,!B&&!u&&e.createElement("button",{onClick:W,disabled:!o||s,style:{...n.button,backgroundColor:J(),color:j||"#FFFFFF",cursor:!o||s?"not-allowed":"pointer",opacity:!o||s?.7:1,...c?JSON.parse(c):{}}},e.createElement("span",{style:{display:"inline-flex",alignItems:"center"}},s&&e.createElement("svg",{style:n.spinner,xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24"},e.createElement("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.createElement("path",{fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})),V())),U&&a&&e.createElement(P,{isOpen:!0,onClose:()=>g(!1)},e.createElement("div",{style:n.certModal},e.createElement("h2",{style:{fontSize:"1.125rem",fontWeight:600}},"A valid certificate already exists for ",y),e.createElement("p",{style:{fontSize:"0.875rem",color:"#4B5563"}},"You can use this certificate or upload a new one."),e.createElement("div",{style:n.certInfoBox},e.createElement("p",null,e.createElement("strong",null,"Reason:")," ",a.actualTaxCode.name),e.createElement("p",null,e.createElement("strong",null,"Signed:")," ",new Date(a.certificate.signedDate).toLocaleDateString()),e.createElement("p",null,e.createElement("strong",null,"Expires:")," ",a.certificate.expirationDate?new Date(a.certificate.expirationDate).toLocaleDateString():"N/A"),e.createElement("button",{onClick:()=>D(d(l,`certificate/${a.certificate.id}`)),style:n.viewPdfBtn},"View PDF")),e.createElement("div",{style:n.actions},e.createElement("button",{style:n.useCertBtn,onClick:()=>{g(!1),x(!0),f==null||f(!0)}},"Use This Certificate"),e.createElement("button",{style:{...n.uploadCertBtn,backgroundColor:v},onClick:async()=>{g(!1);const r=await fetch(d(l,"gencert/token"),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({customerCode:o,...h})}),{token:t}=await r.json();C(t),p(!0)}},"Upload New Certificate")))),k&&e.createElement(Y,{isOpen:!!k,onClose:()=>D(null),pdfUrl:k,title:"Certificate PDF Preview"}),B&&E&&e.createElement(P,{isOpen:!0,onClose:T},e.createElement(G,{token:E,state:y,showDownload:M,manualValidation:O,onCertificateComplete:H,onClose:T,customerInfo:h,customerCode:o,mode:"renew",onComplete:f,environment:N})),u&&e.createElement("div",{style:n.success},e.createElement("button",{disabled:!0,style:{...n.successBtn,...c?JSON.parse(c):{}}},"Exempt \u2713")),w&&e.createElement("div",{style:n.error},e.createElement("p",null,w)))}export{oe as ExemptionIqClient};
