#!/usr/bin/env node
import t from"fs";import e from"path";import E from"readline";function N(i){let n=!1,a=!1,o=!1,p="",j="";for(let r=0;r<i.length;r++){const l=i[r],u=i[r+1];if(a){(l===""||l==="")&&(a=!1,p+=l);continue}if(o){l==="*"&&u==="/"&&(o=!1,r++);continue}if(!n){if(l==="/"&&u==="/"){a=!0,r++;continue}if(l==="/"&&u==="*"){o=!0,r++;continue}}l==='"'&&j!=='"'&&(n=!n),p+=l,j=l}return p}const J={certificate:["certificate","[id]","route.ts"],token:["gencert","token","route.ts"],validate:["validate","route.ts"],customer:["customer","route.ts"],certificates:["certificates","route.ts"],session:["session","route.ts"]},k=E.createInterface({input:process.stdin,output:process.stdout}),d=process.cwd();function $(i){try{if(!t.existsSync(i))return null;const n=t.readFileSync(i,"utf-8");return JSON.parse(N(n))}catch{return null}}function U(i,n){for(const a of n){const o=e.join(i,a);if(t.existsSync(o))return o}return null}function v(i){return i.replace(/\\/g,"/")}function O(i,n){return!!(i?.dependencies?.[n]||i?.devDependencies?.[n])}function z(i){const n=U(i,["next.config.js","next.config.mjs","next.config.cjs","next.config.ts"]);if(!n)return!1;try{const a=t.readFileSync(n,"utf-8");return/appDir\s*:\s*false/.test(a)}catch{return!1}}function P(i){const n=$(e.join(i,"package.json")),a=O(n,"@remix-run/dev")||O(n,"@remix-run/node"),o=O(n,"next"),p=O(n,"astro");if(a){const l=e.join(i,"app","routes");if(t.existsSync(l))return{framework:"remix",apiDir:v(e.join("app","routes"))}}if(o){const l=t.existsSync(e.join(i,"app")),u=t.existsSync(e.join(i,"src","app")),y=t.existsSync(e.join(i,"pages","api")),q=t.existsSync(e.join(i,"src","pages","api")),D=z(i);let S,h=!1;D&&(y||q)?(S="pages",h=q):l||u?(S="app",h=u):y||q?(S="pages",h=q):(S="app",h=t.existsSync(e.join(i,"src")));const F=S==="app"?e.join(h?"src":"","app","api","exemption-iq"):e.join(h?"src":"","pages","api","exemption-iq");return{framework:"next",apiDir:v(F),next:{router:S,useSrc:h}}}if(p)return{framework:"astro",apiDir:v(e.join("src","pages","api","exemption-iq"))};const j=t.existsSync(e.join(i,"app"))||t.existsSync(e.join(i,"src","app")),r=t.existsSync(e.join(i,"pages","api"))||t.existsSync(e.join(i,"src","pages","api"));if(j||r){const l=j?"app":"pages",u=t.existsSync(e.join(i,"src"))&&(t.existsSync(e.join(i,"src","app"))||t.existsSync(e.join(i,"src","pages","api"))),y=l==="app"?e.join(u?"src":"","app","api","exemption-iq"):e.join(u?"src":"","pages","api","exemption-iq");return{framework:"next",apiDir:v(y),next:{router:l,useSrc:u}}}return t.existsSync(e.join(i,"src"))?{framework:"express",apiDir:v(e.join("src","api","exemption-iq"))}:{framework:"generic",apiDir:v(e.join("api","exemption-iq"))}}function w(i){const n=$(e.join(i,"tsconfig.json"))||$(e.join(i,"tsconfig.base.json")),a=$(e.join(i,"jsconfig.json")),o=n&&n.compilerOptions||a&&a.compilerOptions||{};return{baseUrl:o.baseUrl,paths:o.paths}}function V(i){const{baseUrl:n,paths:a}=w(i),o=a?.["@/*"];if(!o||o.length===0)return!1;const p=n||".",j=o[0].replace(/\*$/,"").replace(/\/\*$/,"").replace(/^\.\//,""),r=e.normalize(e.join(p,j));return r==="."||r===""}function _(i){const{baseUrl:n}=w(i),a=e.resolve(i,n||"."),o=e.resolve(i,"vendor","exemption-iq","dist","index");let p=v(e.relative(a,o));return p.startsWith(".")||(p="./"+p),p}function I(i,n){const a=e.join(i,"vendor","exemption-iq","dist","server","helpers");let o=v(e.relative(e.dirname(n),a));return o.startsWith(".")||(o="./"+o),o}async function B(){console.log(`\u{1F680} ExemptionIQ CLI running!
`);const i=P(d),{framework:n,apiDir:a}=i,o=n==="remix",p=n==="next",j=e.dirname(process.argv[1]);let r=e.resolve(j,"../../templates",n);if(p){const s=i.next.router,m=e.resolve(r,s);t.existsSync(m)&&(r=m)}if(!t.existsSync(r)){console.log(`\u274C No templates found for framework: ${n}`),k.close();return}const l=Object.fromEntries(Object.entries(J).map(([s,m])=>{if(o)return s==="certificate"?[s,["exemption-iq.certificate.$id.ts"]]:s==="token"?[s,["exemption-iq.gencert.token.ts"]]:[s,[`exemption-iq.${s}.ts`]];if(n==="astro"){const c=m.filter(f=>f!=="route.ts").map(f=>f==="[id]"?"[id]":f).join("-")+".ts";return[s,[c]]}if(p&&i.next.router==="pages"){const c=m.filter(f=>f!=="route.ts");if(c.length===1)return[s,[`${c[0]}.ts`]];if(c.length===2){const[f,g]=c;return/^\[.*\]$/.test(g)?[s,[f,`${g}.ts`]]:[s,[f,`${g}.ts`]]}if(c.length===3){const[f,g,x]=c;return[s,[f,`${g}.ts`]]}return[s,c]}return[s,m]})),u=e.join(d,a);k.close(),t.mkdirSync(u,{recursive:!0});const y=[],q=V(d);for(const[s,m]of Object.entries(l)){let A=function(){return n==="remix"||n==="astro"?I(d,g):q?"@/vendor/exemption-iq/dist/server/helpers":I(d,g)};var F=A;const c=m[m.length-1],f=e.join(u,...m.slice(0,-1)),g=e.join(f,c),x=e.join(r,`${s}.template.ts`);if(!t.existsSync(x)){console.log(`\u26A0\uFE0F Skipping ${s} \u2014 template not found at: ${x}`);continue}t.mkdirSync(f,{recursive:!0});let b=t.readFileSync(x,"utf-8");const C=A();if(b=b.replace(/__EIQ_VENDOR__/g,C),t.existsSync(g))try{t.chmodSync(g,420)}catch{}t.writeFileSync(g,b);try{t.chmodSync(g,292)}catch{}y.push(g)}const D=e.join(d,".gitignore"),S="vendor/";t.existsSync(D)?t.readFileSync(D,"utf-8").includes(S)||(t.appendFileSync(D,`
${S}`),console.log("\u{1F4C4} Added 'vendor/' to .gitignore")):(t.writeFileSync(D,`${S}
`),console.log("\u{1F4C4} Created .gitignore and added 'vendor/'"));try{const s=e.resolve(e.dirname(process.argv[1]),"../../templates");t.rmSync(s,{recursive:!0,force:!0}),console.log("\u{1F5D1}\uFE0F  Removed entire templates directory after scaffolding.")}catch(s){console.warn("\u26A0\uFE0F  Failed to remove templates directory:",s)}if(n==="astro"){const s=e.join(d,"astro.config.mjs");if(t.existsSync(s)){let m=t.readFileSync(s,"utf-8");const c=!m.includes("output:"),f=!m.includes("optimizeDeps")||!m.includes("exemption-iq");if(c||f){const g=m.indexOf("defineConfig({")+14;let x=m;c&&(x=x.slice(0,g)+`
  output: 'server',`+x.slice(g),console.log("\u{1F527} Patched Astro config with `output: 'server'`")),f&&(x.includes("vite:")?x=x.replace(/include:\s*\[([^\]]*)\]/,(C,R)=>`include: [${R.trim()?R+",":""} 'exemption-iq']`):x=x.slice(0,g)+`
    vite: {
      optimizeDeps: {
        include: ['exemption-iq']
      }
    },`+x.slice(g),console.log("\u{1F527} Patched Astro config with Vite optimizeDeps.include ['exemption-iq']")),t.writeFileSync(s,x,"utf-8")}else console.log("\u2705 Astro config already contains necessary vite + output settings.")}else console.warn("\u26A0\uFE0F Could not find astro.config.mjs to patch.")}const h=s=>{if(!t.existsSync(s))return;const m=t.readFileSync(s,"utf-8"),c=JSON.parse(N(m));c.compilerOptions=c.compilerOptions||{},c.compilerOptions.paths=c.compilerOptions.paths||{};const f=_(d);c.compilerOptions.paths["exemption-iq"]?console.log(`\u2705 ${e.basename(s)} already includes exemption-iq path alias`):(c.compilerOptions.paths["exemption-iq"]=[f],t.writeFileSync(s,JSON.stringify(c,null,2)),console.log(`\u{1F527} Patched ${e.basename(s)} with exemption-iq path alias`)),c.compilerOptions.paths["exemption-iq"]?console.log(`\u2705 ${e.basename(s)} already includes exemption-iq path alias`):(c.compilerOptions.paths["exemption-iq"]=[f],t.writeFileSync(s,JSON.stringify(c,null,2)),console.log(`\u{1F527} Patched ${e.basename(s)} with exemption-iq path alias`))};(n==="next"||n==="remix")&&h(e.join(d,"tsconfig.json")),n==="astro"&&h(e.join(d,"tsconfig.app.json")),y.forEach(s=>console.log(`\u2705 Created ${v(e.relative(d,s))}`))}(async()=>{if(process.argv.slice(2).includes("--uninstall")){const n=e.join(d,"vendor","exemption-iq"),a=e.join(d,"package.json");let o=!1;if(t.existsSync(a)){const r=$(a)||{};r.dependencies&&r.dependencies["exemption-iq"]&&(delete r.dependencies["exemption-iq"],t.writeFileSync(a,JSON.stringify(r,null,2)),console.log("\u{1F9F9} Removed 'exemption-iq' from package.json"),o=!0)}t.existsSync(n)&&(t.rmSync(n,{recursive:!0,force:!0}),console.log("\u{1F9FC} Deleted vendor/exemption-iq directory"),o=!0);const p=P(d),j=e.join(d,p.apiDir);if(p.framework==="remix"){const r=e.join(d,"app","routes"),l=["exemption-iq.certificate.$id.ts","exemption-iq.gencert.token.ts","exemption-iq.validate.ts","exemption-iq.customer.ts","exemption-iq.certificates.ts","exemption-iq.session.ts"];for(const u of l){const y=e.join(r,u);t.existsSync(y)&&(t.rmSync(y),console.log(`\u{1F9FC} Deleted ${u}`),o=!0)}}else if(t.existsSync(j))t.rmSync(j,{recursive:!0,force:!0}),console.log(`\u{1F9FC} Deleted scaffolded API route: ${v(p.apiDir)}`),o=!0;else if(p.framework==="astro"){const r=e.join(d,"src","pages","api","exemption-iq"),l=["certificate-[id].ts","gencert-token.ts","validate.ts","customer.ts","certificates.ts","session.ts"];for(const u of l){const y=e.join(r,u);t.existsSync(y)&&(t.rmSync(y),console.log(`\u{1F9FC} Deleted ${u}`),o=!0)}}console.log(o?"\u2705 Uninstall complete.":"\u2139\uFE0F Nothing to uninstall. No exemption-iq dependency, vendor folder, or API route found."),k.close(),process.exit(0)}else await B()})();
